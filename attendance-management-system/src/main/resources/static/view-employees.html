<!DOCTYPE html>
<html>
<head>
    <title>View Employees - Attendance Management</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <!-- Navigation -->
        <nav class="navbar">
            <a href="index.html">ğŸ  Home</a>
            <a href="add-employee.html">â• Add Employee</a>
            <a href="view-employees.html" class="active">ğŸ‘¥ View Employees</a>
            <a href="attendance-records.html">ğŸ“Š Records</a>
            <a href="fingerprint-verify.html">ğŸ” Verify Attendance</a>
        </nav>

        <!-- Header -->
        <div class="header">
            <h1>ğŸ‘¥ Employee Directory</h1>
            <p>View and manage all registered employees</p>
        </div>

        <!-- Statistics -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-number" id="totalEmployees">0</div>
                <div class="stat-label">Total Employees</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeEmployees">0</div>
                <div class="stat-label">Active Employees</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="exEmployees">0</div>
                <div class="stat-label">ğŸ—ƒï¸ Ex Employees</div>
            </div>
        </div>

        <!-- Search -->
        <div class="search-container">
            <input type="text" id="searchInput" class="search-input" placeholder="ğŸ” Search employees by name, email, or department...">
            <button onclick="refreshEmployees()" style="padding: 12px 24px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer;">ğŸ”„ Refresh</button>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="loading">
            <div>â³ Loading employees...</div>
        </div>

        <!-- Employee Table -->
        <div id="tableContainer" class="table-container" style="display: none;">
            <table class="employee-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ğŸ‘¤ Name</th>
                        <th>ğŸ”‘ Fingerprint ID</th>
                        <th>ğŸ“§ Email</th>
                        <th>ğŸ¢ Department</th>
                        <th>ğŸ“Š Status</th>
                        <th>ğŸ› ï¸ Actions</th>
                    </tr>
                </thead>
                <tbody id="employeeTableBody"></tbody>
            </table>
        </div>

        <!-- No Employees State -->
        <div id="noEmployeesState" class="no-employees" style="display: none;">
            <h3>ğŸ‘¥ No Employees Found</h3>
            <p>No employees have been registered yet.</p>
            <a href="add-employee.html" style="color: #007bff; text-decoration: none; font-weight: bold;">â• Add the first employee</a>
        </div>

        <!-- Ex-Employees Section -->
        <div class="ex-employees-section">
            <div class="section-header">ğŸ—ƒï¸ Ex-Employees Archive</div>
            
            <div id="exEmployeesContainer" class="table-container" style="display: none;">
                <table class="ex-employee-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>ğŸ‘¤ Name</th>
                            <th>ğŸ”‘ Fingerprint ID</th>
                            <th>ğŸ“§ Email</th>
                            <th>ğŸ¢ Department</th>
                            <th>ğŸ“… Deleted Date</th>
                            <th>ğŸ› ï¸ Actions</th>
                        </tr>
                    </thead>
                    <tbody id="exEmployeeTableBody"></tbody>
                </table>
            </div>

            <div id="noExEmployeesState" class="no-employees" style="display: block;">
                <h3>ğŸ—ƒï¸ No Ex-Employees</h3>
                <p>No employees have been deleted yet.</p>
            </div>
        </div>

        <!-- Back to Home -->
        <div style="text-align: center; margin-top: 30px;">
            <a href="index.html" style="color: #007bff; text-decoration: none;">â† Back to Home</a>
        </div>
    </div>

    <!-- Confirmation Dialog -->
    <div id="confirmDialog" class="confirm-dialog">
        <div class="confirm-content">
            <h3>âš ï¸ Confirm Deletion</h3>
            <p id="confirmMessage">Are you sure you want to delete this employee?</p>
            <div class="confirm-buttons">
                <button class="confirm-btn confirm-yes" onclick="confirmDelete()">Yes, Delete</button>
                <button class="confirm-btn confirm-no" onclick="cancelDeleteFunction()" type="button">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const BASE_URL = "https://amsapplication-production.up.railway.app";
        let allEmployees = [];
        let filteredEmployees = [];
        let exEmployees = [];
        let employeeToDelete = null;

        // ğŸ”¹ Helper function with /api fallback
        async function fetchWithFallback(endpoint, options = {}) {
            try {
                let res = await fetch(`${BASE_URL}/api${endpoint}`, options);
                if (res.ok) return res;
                console.warn("Fallback: trying without /api");
                return await fetch(`${BASE_URL}${endpoint}`, options);
            } catch (e) {
                console.error("Both fetch attempts failed:", e);
                throw e;
            }
        }

        window.addEventListener('load', function() {
            loadEmployees();
            loadExEmployees();
        });

        document.getElementById('searchInput').addEventListener('input', filterEmployees);

        async function loadEmployees() {
            showLoading();
            try {
                const response = await fetchWithFallback("/employees");
                if (response.ok) {
                    allEmployees = await response.json();
                    console.log("âœ… Employees:", allEmployees);
                    filteredEmployees = [...allEmployees];
                    displayEmployees();
                    updateStatistics();
                    showTable();
                } else throw new Error('Failed to fetch employees');
            } catch (error) {
                console.error('Error loading employees:', error);
                showNoEmployees();
            }
        }

        function filterEmployees() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            filteredEmployees = allEmployees.filter(emp =>
                emp.name.toLowerCase().includes(searchTerm) ||
                (emp.email && emp.email.toLowerCase().includes(searchTerm)) ||
                (emp.department && emp.department.toLowerCase().includes(searchTerm)) ||
                (emp.fingerprintId && emp.fingerprintId.toLowerCase().includes(searchTerm))
            );
            displayEmployees();
            updateStatistics();
        }

        function displayEmployees() {
            const tableBody = document.getElementById('employeeTableBody');
            tableBody.innerHTML = '';
            filteredEmployees.forEach(emp => {
                const status = emp.fingerprintId ? 'Active' : 'Incomplete';
                const statusClass = emp.fingerprintId ? 'status-active' : 'status-incomplete';
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td><strong>#${emp.id}</strong></td>
                    <td><strong>${emp.name}</strong></td>
                    <td><span class="fingerprint-id">${emp.fingerprintId || 'Not Set'}</span></td>
                    <td>${emp.email || 'Not provided'}</td>
                    <td>${emp.department || 'Unassigned'}</td>
                    <td><span class="status-badge ${statusClass}">${status}</span></td>
                    <td><button class="delete-btn" onclick="deleteEmployee(${emp.id}, '${emp.name}')">ğŸ—‘ï¸ Delete</button></td>
                `;
            });
        }

        function deleteEmployee(id, name) {
            employeeToDelete = { id, name };
            document.getElementById('confirmMessage').textContent =
                `Are you sure you want to delete "${name}"? This action cannot be undone.`;
            document.getElementById('confirmDialog').style.display = 'flex';
        }

        function cancelDeleteFunction() {
            employeeToDelete = null;
            document.getElementById('confirmDialog').style.display = 'none';
        }

        async function confirmDelete() {
            if (!employeeToDelete) return;
            try {
                const response = await fetchWithFallback(`/employees/${employeeToDelete.id}`, { method: 'DELETE' });
                if (response.ok) {
                    allEmployees = allEmployees.filter(emp => emp.id !== employeeToDelete.id);
                    filteredEmployees = filteredEmployees.filter(emp => emp.id !== employeeToDelete.id);
                    displayEmployees();
                    updateStatistics();
                    await loadExEmployees();
                    alert(`âœ… Employee "${employeeToDelete.name}" moved to Ex-Employees archive!`);
                    cancelDeleteFunction();
                } else {
                    const error = await response.text();
                    alert(`âŒ Failed to delete employee: ${error}`);
                }
            } catch (error) {
                console.error('Error deleting employee:', error);
                alert('âŒ Network error occurred while deleting employee.');
            }
        }

        function showLoading() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('tableContainer').style.display = 'none';
            document.getElementById('noEmployeesState').style.display = 'none';
        }

        function showTable() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('tableContainer').style.display = 'block';
            document.getElementById('noEmployeesState').style.display = 'none';
        }

        function showNoEmployees() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('tableContainer').style.display = 'none';
            document.getElementById('noEmployeesState').style.display = 'block';
        }

        function refreshEmployees() {
            loadEmployees();
            loadExEmployees();
        }

        function displayExEmployees() {
            const exTableBody = document.getElementById('exEmployeeTableBody');
            const exContainer = document.getElementById('exEmployeesContainer');
            const noExEmployeesState = document.getElementById('noExEmployeesState');
            exTableBody.innerHTML = '';
            exContainer.style.display = 'block';
            noExEmployeesState.style.display = exEmployees.length === 0 ? 'block' : 'none';
            exEmployees.forEach(emp => {
                const row = exTableBody.insertRow();
                row.innerHTML = `
                    <td><strong>#${emp.id || ''}</strong></td>
                    <td><strong>${emp.name || ''}</strong></td>
                    <td><span class="fingerprint-id">${emp.fingerprintId || 'Not Set'}</span></td>
                    <td>${emp.email || 'Not provided'}</td>
                    <td>${emp.department || 'Unassigned'}</td>
                    <td><span class="status-badge status-deleted">${emp.deletedDate || ''}</span></td>
                    <td><button class="restore-btn" onclick="restoreEmployee(${emp.id}, '${emp.name}')">â™»ï¸ Restore</button></td>
                `;
            });
        }

        async function loadExEmployees() {
            try {
                const response = await fetchWithFallback("/ex-employees");
                if (response.ok) {
                    exEmployees = await response.json();
                    console.log("âœ… Ex-employees:", exEmployees);
                    displayExEmployees();
                    updateStatistics();
                }
            } catch (error) {
                console.error('Error loading ex-employees:', error);
            }
        }

        async function restoreEmployee(id, name) {
            if (!confirm(`Are you sure you want to restore "${name}"?`)) return;
            try {
                const employeeToRestore = exEmployees.find(emp => emp.id === id);
                if (!employeeToRestore) {
                    alert('âŒ Employee not found in archive');
                    return;
                }
                delete employeeToRestore.deletedDate;
                const response = await fetchWithFallback("/employees", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(employeeToRestore)
                });
                if (response.ok) {
                    await fetchWithFallback(`/ex-employees/${id}`, { method: 'DELETE' });
                    exEmployees = exEmployees.filter(emp => emp.id !== id);
                    displayExEmployees();
                    await loadEmployees();
                    await loadExEmployees();
                    alert(`âœ… Employee "${name}" restored successfully!`);
                } else {
                    const error = await response.text();
                    if (error.includes('already exists')) {
                        alert(`âš ï¸ Employee "${name}" is already active.`);
                    } else {
                        alert(`âŒ Failed to restore employee: ${error}`);
                    }
                }
            } catch (error) {
                console.error('Error restoring employee:', error);
                alert('âŒ Failed to restore employee. Please try again.');
            }
        }

        function updateStatistics() {
            document.getElementById('totalEmployees').textContent = allEmployees.length;
            document.getElementById('activeEmployees').textContent = allEmployees.filter(emp => emp.fingerprintId).length;
            document.getElementById('exEmployees').textContent = exEmployees.length;
        }
    </script>
</body>
</html>

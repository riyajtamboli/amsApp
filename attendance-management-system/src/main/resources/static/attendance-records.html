<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Attendance Records - Attendance Management</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">
    <!-- Navbar -->
    <nav class="navbar">
        <a href="index.html">🏠 Home</a>
        <a href="add-employee.html">➕ Add Employee</a>
        <a href="view-employees.html">👥 View Employees</a>
        <a href="attendance-records.html" class="active">📊 Records</a>
        <a href="fingerprint-verify.html">🔐 Verify Attendance</a>
    </nav>

    <!-- Header -->
    <div class="header">
        <h1>📊 Attendance Records</h1>
        <p>View and analyze employee attendance history</p>
    </div>

    <!-- Statistics -->
    <div class="stats-container">
        <div class="stat-card"><div id="totalRecords">0</div><div>Total Records</div></div>
        <div class="stat-card"><div id="presentToday">0</div><div>Present Today</div></div>
        <div class="stat-card"><div id="totalEmployees">0</div><div>Total Employees</div></div>
        <div class="stat-card"><div id="attendanceRate">0%</div><div>Attendance Rate</div></div>
    </div>

    <!-- Filter -->
    <div class="filter-section">
        <h3>🔍 Filter Records</h3>
        <div class="filter-container">
            <select id="employeeFilter">
                <option value="all">All Employees</option>
            </select>
            <input type="date" id="fromDate">
            <input type="date" id="toDate">
            <select id="statusFilter">
                <option value="all">All Status</option>
                <option value="PRESENT">Present</option>
                <option value="ABSENT">Absent</option>
            </select>
            <button onclick="applyFilters()">Apply Filters</button>
            <button onclick="resetFilters()">Reset</button>
        </div>
    </div>

    <!-- Absent Employees -->
    <div id="absentSection" class="absent-section" style="display:none;">
        <h3 id="absentHeader">❌ Absent Employees Today</h3>
        <button onclick="exportAbsentCSV()" class="export-btn">📥 Export Absent CSV</button>
        <table class="absent-table">
            <thead>
            <tr>
                <th>Employee ID</th>
                <th>Name</th>
                <th>Department</th>
                <th>Status</th>
            </tr>
            </thead>
            <tbody id="absentTableBody"></tbody>
        </table>
    </div>

    <!-- Attendance Records -->
    <div id="recordsSection" class="records-section">
        <h3>📅 Attendance Records</h3>
        <button onclick="exportRecordsCSV()" class="export-btn">📥 Export CSV</button>
        <table class="records-table">
            <thead>
            <tr>
                <th>Date</th>
                <th>Time</th>
                <th>Employee</th>
                <th>Fingerprint ID</th>
                <th>Department</th>
                <th>Status</th>
            </tr>
            </thead>
            <tbody id="recordsTableBody"></tbody>
        </table>
    </div>
</div>

<script>
    const BASE_URL = "/api"; // adjust if backend is hosted separately
    let allRecords = [];
    let employees = [];
    let absentEmployees = [];

    window.onload = async function () {
        await loadEmployees();
        await loadAttendanceRecords();
    };

    async function loadEmployees() {
        try {
            const res = await fetch(`${BASE_URL}/employees`);
            if (res.ok) {
                employees = await res.json();
                const employeeFilter = document.getElementById("employeeFilter");
                employees.forEach(emp => {
                    const opt = document.createElement("option");
                    opt.value = emp.id;
                    opt.textContent = emp.name;
                    employeeFilter.appendChild(opt);
                });
                document.getElementById("totalEmployees").textContent = employees.length;
            }
        } catch (e) {
            console.error("Error loading employees", e);
        }
    }

    async function loadAttendanceRecords() {
        try {
            const res = await fetch(`${BASE_URL}/attendance`);
            if (res.ok) {
                allRecords = await res.json();
                displayRecords(allRecords);
                updateStats();
                showAbsentEmployees();
            }
        } catch (e) {
            console.error("Error loading attendance", e);
        }
    }

    function displayRecords(records) {
        const tbody = document.getElementById("recordsTableBody");
        tbody.innerHTML = "";
        records.forEach(r => {
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${r.date || ''}</td>
                <td>${r.time || ''}</td>
                <td>${r.employeeName || ''}</td>
                <td>${r.fingerprintId || ''}</td>
                <td>${r.department || ''}</td>
                <td><span class="${r.status === 'PRESENT' ? 'status-present' : 'status-absent'}">${r.status}</span></td>
            `;
        });
    }

    function applyFilters() {
        let filtered = [...allRecords];
        const empId = document.getElementById("employeeFilter").value;
        const from = document.getElementById("fromDate").value;
        const to = document.getElementById("toDate").value;
        const status = document.getElementById("statusFilter").value;

        if (empId !== "all") filtered = filtered.filter(r => r.employeeId == empId);
        if (from) filtered = filtered.filter(r => r.date >= from);
        if (to) filtered = filtered.filter(r => r.date <= to);
        if (status !== "all") filtered = filtered.filter(r => r.status === status);

        displayRecords(filtered);
    }

    function resetFilters() {
        document.getElementById("employeeFilter").value = "all";
        document.getElementById("fromDate").value = "";
        document.getElementById("toDate").value = "";
        document.getElementById("statusFilter").value = "all";
        displayRecords(allRecords);
    }

    function showAbsentEmployees() {
        const today = new Date().toISOString().split("T")[0];
        absentEmployees = employees.filter(emp =>
            !allRecords.some(r => r.employeeId === emp.id && r.date === today && r.status === "PRESENT")
        );
        if (absentEmployees.length > 0) {
            document.getElementById("absentSection").style.display = "block";
            document.getElementById("absentHeader").textContent = `${absentEmployees.length} employees absent on ${today}`;
            const tbody = document.getElementById("absentTableBody");
            tbody.innerHTML = "";
            absentEmployees.forEach(emp => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${emp.fingerprintId}</td>
                    <td>${emp.name}</td>
                    <td>${emp.department || '-'}</td>
                    <td><span class="status-absent">ABSENT</span></td>
                `;
            });
        }
    }

    function updateStats() {
        const today = new Date().toISOString().split("T")[0];
        const total = allRecords.length;
        const presentToday = allRecords.filter(r => r.date === today && r.status === "PRESENT").length;
        document.getElementById("totalRecords").textContent = total;
        document.getElementById("presentToday").textContent = presentToday;
        document.getElementById("attendanceRate").textContent =
            employees.length > 0 ? Math.round((presentToday / employees.length) * 100) + "%" : "0%";
    }

    // CSV Export Helpers
    function exportCSV(data, filename, headers) {
        let csvContent = headers.join(",") + "\n";
        data.forEach(row => {
            csvContent += row.map(item => `"${item}"`).join(",") + "\n";
        });
        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
    }

    function exportAbsentCSV() {
        if (absentEmployees.length === 0) return alert("No absent employees to export.");
        const rows = absentEmployees.map(emp => [emp.fingerprintId, emp.name, emp.department || '-', "ABSENT"]);
        exportCSV(rows, "absent-employees.csv", ["Employee ID", "Name", "Department", "Status"]);
    }

    function exportRecordsCSV() {
        if (allRecords.length === 0) return alert("No records to export.");
        const rows = allRecords.map(r => [r.date, r.time, r.employeeName, r.fingerprintId, r.department, r.status]);
        exportCSV(rows, "attendance-records.csv", ["Date", "Time", "Employee", "Fingerprint ID", "Department", "Status"]);
    }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Attendance Records - Attendance Management</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <!-- Navigation -->
    <nav class="navbar">
      <a href="index.html">ğŸ  Home</a>
      <a href="add-employee.html">â• Add Employee</a>
      <a href="view-employees.html">ğŸ‘¥ View Employees</a>
      <a href="attendance-records.html" class="active">ğŸ“Š Records</a>
      <a href="fingerprint-verify.html">ğŸ” Verify Attendance</a>
    </nav>

    <!-- Header -->
    <div class="header">
      <h1>ğŸ“Š Attendance Records</h1>
      <p>View and analyze employee attendance history</p>
    </div>

    <!-- Stats -->
    <div class="stats-container">
      <div class="stat-card"><div class="stat-number" id="totalRecords">0</div><div class="stat-label">Total Records</div></div>
      <div class="stat-card"><div class="stat-number" id="presentToday">0</div><div class="stat-label">Present Today</div></div>
      <div class="stat-card"><div class="stat-number" id="totalEmployees">0</div><div class="stat-label">Total Employees</div></div>
      <div class="stat-card"><div class="stat-number" id="attendanceRate">0%</div><div class="stat-label">Attendance Rate</div></div>
    </div>

    <!-- Filter Section -->
    <div class="filter-container">
      <h3>ğŸ” Filter Records</h3>
      <label>Employee</label>
      <select id="employeeFilter">
        <option value="all">All Employees</option>
      </select>

      <label>From Date</label>
      <input type="date" id="fromDate">

      <label>To Date</label>
      <input type="date" id="toDate">

      <label>Status</label>
      <select id="statusFilter">
        <option value="all">All Status</option>
        <option value="PRESENT">Present</option>
        <option value="ABSENT">Absent</option>
      </select>

      <div class="filter-buttons">
        <button onclick="applyFilters()">ğŸ” Apply Filters</button>
        <button onclick="resetFilters()">â™» Reset</button>
        <button onclick="loadData()">ğŸ”„ Refresh Data</button>
        <button onclick="exportAllCSV()">ğŸ“¥ Export CSV</button>
      </div>
    </div>

    <!-- Absent Employees Section -->
    <div id="absentSection" class="absent-section">
      <h3>ğŸš« Absent Employees Today</h3>
      <p id="absentCount">0 employees absent today</p>
      <button onclick="exportAbsentCSV()">ğŸ“¥ Export Absent CSV</button>
      <table class="absent-table" id="absentTable">
        <thead>
          <tr><th>ID</th><th>Name</th><th>Department</th><th>Status</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Attendance Records -->
    <div class="records-section">
      <h3>ğŸ“… Attendance Records</h3>
      <table class="records-table" id="recordsTable">
        <thead>
          <tr>
            <th>ğŸ“… Date</th>
            <th>â° Time</th>
            <th>ğŸ‘¤ Employee</th>
            <th>ğŸ”‘ Fingerprint ID</th>
            <th>ğŸ¢ Department</th>
            <th>ğŸ“Š Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="noRecords" style="display:none; text-align:center; margin:20px;">ğŸ“­ No attendance records found</div>
    </div>
  </div>

  <script>
    const BASE_URL = "/api";
    let employees = [];
    let attendanceRecords = [];

    window.addEventListener("load", () => {
      loadEmployees();
      loadData();
    });

    async function loadEmployees() {
      try {
        const res = await fetch(`${BASE_URL}/employees`);
        if (!res.ok) throw new Error("Failed to fetch employees");
        employees = await res.json();

        const employeeSelect = document.getElementById("employeeFilter");
        employeeSelect.innerHTML = `<option value="all">All Employees</option>`;
        employees.forEach(emp => {
          const opt = document.createElement("option");
          opt.value = emp.id;
          opt.textContent = `${emp.name} (${emp.fingerprintId})`;
          employeeSelect.appendChild(opt);
        });

        document.getElementById("totalEmployees").textContent = employees.length;
      } catch (err) {
        console.error("Error loading employees:", err);
      }
    }

    async function loadData() {
      try {
        const res = await fetch(`${BASE_URL}/attendance/records`);
        if (!res.ok) throw new Error("Failed to fetch records");
        attendanceRecords = await res.json();
        displayRecords(attendanceRecords);
        calculateStats();
        displayAbsent();
      } catch (err) {
        console.error("Error loading records:", err);
      }
    }

    function displayRecords(records) {
      const tbody = document.querySelector("#recordsTable tbody");
      tbody.innerHTML = "";
      if (records.length === 0) {
        document.getElementById("noRecords").style.display = "block";
        return;
      }
      document.getElementById("noRecords").style.display = "none";
      records.forEach(rec => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${rec.date || ""}</td>
          <td>${rec.time || ""}</td>
          <td>${rec.employeeName || ""}</td>
          <td>${rec.fingerprintId || ""}</td>
          <td>${rec.department || ""}</td>
          <td>${rec.status}</td>
        `;
        tbody.appendChild(row);
      });
      document.getElementById("totalRecords").textContent = records.length;
    }

    function calculateStats() {
      const today = new Date().toISOString().split("T")[0];
      const todayRecords = attendanceRecords.filter(r => r.date === today && r.status === "PRESENT");
      document.getElementById("presentToday").textContent = todayRecords.length;

      const rate = employees.length > 0
        ? Math.round((todayRecords.length / employees.length) * 100)
        : 0;
      document.getElementById("attendanceRate").textContent = rate + "%";
    }

    function displayAbsent() {
      const today = new Date().toISOString().split("T")[0];
      const presentIds = attendanceRecords.filter(r => r.date === today && r.status === "PRESENT").map(r => r.employeeId);
      const absent = employees.filter(e => !presentIds.includes(e.id));

      const tbody = document.querySelector("#absentTable tbody");
      tbody.innerHTML = "";
      absent.forEach(emp => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${emp.fingerprintId}</td>
          <td>${emp.name}</td>
          <td>${emp.department || ""}</td>
          <td><span style="color:red; font-weight:bold;">ABSENT</span></td>
        `;
        tbody.appendChild(row);
      });

      document.getElementById("absentCount").textContent =
        `${absent.length} employees absent on ${today}`;
    }

    function applyFilters() {
      let filtered = [...attendanceRecords];
      const empId = document.getElementById("employeeFilter").value;
      const fromDate = document.getElementById("fromDate").value;
      const toDate = document.getElementById("toDate").value;
      const status = document.getElementById("statusFilter").value;

      if (empId !== "all") filtered = filtered.filter(r => r.employeeId == empId);
      if (fromDate) filtered = filtered.filter(r => r.date >= fromDate);
      if (toDate) filtered = filtered.filter(r => r.date <= toDate);
      if (status !== "all") filtered = filtered.filter(r => r.status === status);

      displayRecords(filtered);
    }

    function resetFilters() {
      document.getElementById("employeeFilter").value = "all";
      document.getElementById("fromDate").value = "";
      document.getElementById("toDate").value = "";
      document.getElementById("statusFilter").value = "all";
      displayRecords(attendanceRecords);
    }

    function exportAllCSV() {
      exportCSV(attendanceRecords, "attendance_records.csv");
    }

    function exportAbsentCSV() {
      const today = new Date().toISOString().split("T")[0];
      const presentIds = attendanceRecords.filter(r => r.date === today && r.status === "PRESENT").map(r => r.employeeId);
      const absent = employees.filter(e => !presentIds.includes(e.id));
      exportCSV(absent, "absent_employees.csv");
    }

    function exportCSV(data, filename) {
      if (!data || data.length === 0) {
        alert("No data available for export");
        return;
      }
      const headers = Object.keys(data[0]);
      const csvRows = [headers.join(",")];
      for (const row of data) {
        csvRows.push(headers.map(h => `"${row[h] || ""}"`).join(","));
      }
      const csvContent = csvRows.join("\n");
      const blob = new Blob([csvContent], { type: "text/csv" });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.click();
    }
  </script>
</body>
</html>

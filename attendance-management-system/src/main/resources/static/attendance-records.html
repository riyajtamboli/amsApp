<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Attendance Records | Smart Attendance System</title>
  <link rel="stylesheet" href="modern-styles.css">
</head>
<body>
<div class="container">

  <!-- Navbar -->
  <nav class="navbar">
    <a href="index.html">🏠 Dashboard</a>
    <a href="employees.html">👨‍💼 Employees</a>
    <a href="attendance-record.html" class="active">📊 Attendance</a>
    <a href="reports.html">📑 Reports</a>
  </nav>

  <!-- Header -->
  <div class="header">
    <h1>📊 Attendance Records</h1>
    <p>Track employee attendance history and daily absentees</p>
  </div>

  <!-- Stats -->
  <div class="stats-container">
    <div class="stat-card">
      <span class="stat-number" id="totalRecords">0</span>
      <span class="stat-label">Total Records</span>
    </div>
    <div class="stat-card">
      <span class="stat-number" id="presentToday">0</span>
      <span class="stat-label">Present Today</span>
    </div>
    <div class="stat-card">
      <span class="stat-number" id="totalEmployees">0</span>
      <span class="stat-label">Total Employees</span>
    </div>
    <div class="stat-card">
      <span class="stat-number" id="attendanceRate">0%</span>
      <span class="stat-label">Attendance Rate</span>
    </div>
  </div>

  <!-- Filters -->
  <div class="glass-card">
    <h3 class="gradient-text">🔍 Filter Records</h3>
    <div class="search-container">
      <select id="employeeFilter" class="filter-select"></select>
      <input type="date" id="fromDate" class="filter-select">
      <input type="date" id="toDate" class="filter-select">
      <select id="statusFilter" class="filter-select">
        <option value="">All</option>
        <option value="PRESENT">Present</option>
        <option value="ABSENT">Absent</option>
      </select>
    </div>
    <div style="margin-top:15px;">
      <button class="btn" onclick="applyFilters()">🔎 Apply Filters</button>
      <button class="btn btn-secondary" onclick="resetFilters()">♻ Reset</button>
      <button class="btn" onclick="fetchAttendanceRecords()">🔄 Refresh</button>
      <button class="btn btn-success" onclick="exportCSV()">📥 Export CSV</button>
    </div>
  </div>

  <!-- Absent Employees -->
  <div class="glass-card">
    <h3 class="gradient-text">🚫 Absent Employees Today</h3>
    <div class="message error">
      <span id="absentCount">0</span> employees absent on <span id="todayDate"></span>
    </div>
    <button class="btn btn-danger" onclick="exportAbsentCSV()">📥 Export Absent CSV</button>
  </div>

  <!-- Attendance Table -->
  <div class="table-container glass-card">
    <table class="table">
      <thead>
        <tr>
          <th>📅 Date</th>
          <th>⏰ Time</th>
          <th>👤 Employee</th>
          <th>🔑 Fingerprint ID</th>
          <th>🏢 Department</th>
          <th>📌 Status</th>
        </tr>
      </thead>
      <tbody id="attendanceTable">
        <tr><td colspan="6" class="loading">Loading attendance records...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
let allRecords = [];
let employees = [];

async function fetchEmployees() {
  const res = await fetch("/api/employees");
  employees = await res.json();
  const select = document.getElementById("employeeFilter");
  select.innerHTML = `<option value="">All Employees</option>`;
  employees.forEach(e => {
    select.innerHTML += `<option value="${e.fingerprintId}">${e.name} (${e.fingerprintId})</option>`;
  });
  document.getElementById("totalEmployees").innerText = employees.length;
}

async function fetchAttendanceRecords() {
  const res = await fetch("/api/attendance/records");
  allRecords = await res.json();
  renderTable(allRecords);
  updateStats(allRecords);
  checkAbsent(allRecords);
}

function renderTable(records) {
  const tbody = document.getElementById("attendanceTable");
  if (!records.length) {
    tbody.innerHTML = `<tr><td colspan="6" class="loading">No attendance records found</td></tr>`;
    return;
  }
  tbody.innerHTML = records.map(r => `
    <tr>
      <td>${r.date}</td>
      <td>${r.time}</td>
      <td>${r.employeeName}</td>
      <td>${r.fingerprintId}</td>
      <td>${r.department}</td>
      <td><span class="message ${r.status==='PRESENT'?'success':'error'}">${r.status}</span></td>
    </tr>
  `).join("");
}

function updateStats(records) {
  document.getElementById("totalRecords").innerText = records.length;
  const present = records.filter(r => r.status === "PRESENT").length;
  document.getElementById("presentToday").innerText = present;
  const total = employees.length || 1;
  document.getElementById("attendanceRate").innerText = ((present / total) * 100).toFixed(1) + "%";
}

function applyFilters() {
  let filtered = [...allRecords];
  const empId = document.getElementById("employeeFilter").value;
  const from = document.getElementById("fromDate").value;
  const to = document.getElementById("toDate").value;
  const status = document.getElementById("statusFilter").value;

  if (empId) filtered = filtered.filter(r => r.fingerprintId === empId);
  if (from) filtered = filtered.filter(r => r.date >= from);
  if (to) filtered = filtered.filter(r => r.date <= to);
  if (status) filtered = filtered.filter(r => r.status === status);

  renderTable(filtered);
  updateStats(filtered);
}

function resetFilters() {
  document.getElementById("employeeFilter").value = "";
  document.getElementById("fromDate").value = "";
  document.getElementById("toDate").value = "";
  document.getElementById("statusFilter").value = "";
  renderTable(allRecords);
  updateStats(allRecords);
}

async function checkAbsent(records) {
  const today = new Date().toISOString().split("T")[0];
  document.getElementById("todayDate").innerText = today;
  const presentIds = records.filter(r => r.date === today && r.status === "PRESENT").map(r => r.fingerprintId);
  const absents = employees.filter(e => !presentIds.includes(e.fingerprintId));
  document.getElementById("absentCount").innerText = absents.length;
  return absents;
}

function downloadCSV(filename, rows) {
  const csv = rows.map(r => r.map(val => `"${val}"`).join(",")).join("\n");
  const blob = new Blob([csv], { type: "text/csv" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.click();
}

function exportCSV() {
  if (!allRecords.length) return alert("No records to export.");
  const rows = [["Date","Time","Employee","Fingerprint ID","Department","Status"]];
  allRecords.forEach(r => rows.push([r.date,r.time,r.employeeName,r.fingerprintId,r.department,r.status]));
  downloadCSV("attendance_records.csv", rows);
}

async function exportAbsentCSV() {
  const absents = await checkAbsent(allRecords);
  if (!absents.length) return alert("No absent employees.");
  const rows = [["ID","Name","Email","Department"]];
  absents.forEach(e => rows.push([e.fingerprintId,e.name,e.email,e.department]));
  downloadCSV("absent_employees.csv", rows);
}

// Init
(async () => {
  await fetchEmployees();
  await fetchAttendanceRecords();
})();
</script>
</body>
</html>
